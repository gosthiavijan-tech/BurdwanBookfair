<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAG - ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶æ‡¶≤</title>
    <style>
        :root { --primary: #9b59b6; --success: #2ecc71; --bg: #f0f2f5; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 450px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 10px solid var(--primary); text-align: center; }
        
        h2 { color: #2d3436; margin-bottom: 25px; }
        .main-nav { display: flex; gap: 10px; margin-bottom: 25px; }
        .nav-btn { flex: 1; padding: 12px; cursor: pointer; border: 2px solid var(--primary); background: white; color: var(--primary); font-weight: bold; border-radius: 8px; transition: 0.3s; }
        .nav-btn.active { background: var(--primary); color: white; }

        .section { display: none; text-align: left; }
        .section.active { display: block; }

        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; }
        .btn-block { width: 100%; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; border: none; font-size: 16px; margin-top: 10px; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        .info-card { background: #f9f0ff; padding: 15px; border-radius: 10px; border-left: 5px solid var(--primary); margin: 15px 0; font-size: 14px; line-height: 1.6; }
        .thanks-box { background: #e8f5e9; color: #2e7d32; padding: 20px; border-radius: 10px; text-align: center; font-weight: bold; border: 1px solid #c8e6c9; margin-top: 15px; }

        .admin-footer { margin-top: 50px; border-top: 1px solid #eee; padding-top: 15px; }
        .admin-link { color: #95a5a6; text-decoration: none; font-size: 13px; cursor: pointer; font-weight: 500; }
        .admin-link:hover { color: var(--primary); }

        #receiptWrapper { display: none; background: white; padding: 20px; border: 1px solid #ddd; border-radius: 10px; margin-top: 20px; position: relative; }
        .r-row { display: flex; justify-content: space-between; margin: 8px 0; border-bottom: 1px solid #f9f9f9; padding-bottom: 5px; font-size: 14px; }
        .stamp { display: inline-block; padding: 8px 15px; border: 3px solid var(--success); color: var(--success); border-radius: 8px; font-weight: bold; transform: rotate(-10deg); font-size: 16px; margin-top: 15px; }

        @media print {
            .no-print { display: none !important; }
            #receiptWrapper { display: block !important; border: 2px solid #333; box-shadow: none; width: 100%; max-width: 100%; }
        }
    </style>
</head>
<body>

<div class="container no-print" id="mainApp">
    <h2>‡¶¨‡¶∞‡ßç‡¶ß‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶≠‡¶ø‡¶Ø‡¶æ‡¶® ‡¶ó‡ßã‡¶∑‡ßç‡¶†‡ßÄ</h2>
    
    <div class="main-nav">
        <button class="nav-btn active" id="btnRenew" onclick="showTab('renew')">‡¶®‡¶¨‡¶æ‡ßü‡¶®</button>
        <button class="nav-btn" id="btnReceipt" onclick="showTab('download')">‡¶∞‡¶∏‡¶ø‡¶¶</button>
    </div>

    <div id="renewTab" class="section active">
        <input type="text" id="renewId" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®">
        <button class="btn-block btn-primary" onclick="searchForRenew()">‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <div id="renewResult"></div>
        
        <div id="paymentArea" style="display:none; margin-top: 20px;">
            <div style="text-align:center; padding:15px; border:2px dashed #ddd; border-radius:10px; margin-bottom: 15px;">
                <p style="font-size:12px; color:#666;">‡¶®‡¶ø‡¶ö‡ßá‡¶∞ QR ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ï‡¶∞‡ßá ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=upi://pay?pa=8016957008@upi&pn=Bardhaman%20Abhijan%20Gosthi" alt="QR">
                <p><b>UPI: 8016957008@upi</b></p>
            </div>
            <input type="text" id="trxIdInput" placeholder="Transaction ID (TrxID) ‡¶¶‡¶ø‡¶®">
            <button class="btn-block btn-success" id="submitBtn" onclick="submitPayment()">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <div id="downloadTab" class="section">
        <input type="text" id="downloadId" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®">
        <button class="btn-block btn-primary" onclick="searchForReceipt()">‡¶∞‡¶∏‡¶ø‡¶¶ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
        <div id="receiptResult"></div>
    </div>

    <div class="admin-footer">
        <span class="admin-link" onclick="adminLogin()">üîí Admin Login</span>
    </div>
</div>

<div id="receiptWrapper" class="container">
    <div style="text-align:center; border-bottom:3px double var(--primary); padding-bottom:10px; margin-bottom:20px;">
        <h2 style="margin:0; color:var(--primary);">‡¶¨‡¶∞‡ßç‡¶ß‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶≠‡¶ø‡¶Ø‡¶æ‡¶® ‡¶ó‡ßã‡¶∑‡ßç‡¶†‡ßÄ</h2>
        <p style="margin:5px 0; font-size:12px;">‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶∂‡¶ø‡¶™ ‡¶∞‡¶∏‡¶ø‡¶¶</p>
    </div>
    <div id="receiptBody"></div>
    <div class="no-print" style="margin-top:25px;">
        <button class="btn-block btn-primary" onclick="window.print()">üñ®Ô∏è ‡¶∞‡¶∏‡¶ø‡¶¶ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° / ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü</button>
        <button class="btn-block" onclick="location.reload()" style="background:#eee;">‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyEtw6soXGy_d7g7kyORHMHSX7m5MOnFOZ1DQKbRKQonMtPxE3gUWO9_3gUGVSAnF-ZSQ/exec';
    let currentMember = null;

    function showTab(tab) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(tab === 'renew') {
            document.getElementById('renewTab').classList.add('active');
            document.getElementById('btnRenew').classList.add('active');
        } else {
            document.getElementById('downloadTab').classList.add('active');
            document.getElementById('btnReceipt').classList.add('active');
        }
    }

    async function searchForRenew() {
        const id = document.getElementById('renewId').value.trim();
        const resDiv = document.getElementById('renewResult');
        if(!id) return alert("‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®");
        
        resDiv.innerHTML = "<p>‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>";
        try {
            const response = await fetch(`${scriptURL}?type=all`);
            const data = await response.json();
            // ‡¶∂‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
            currentMember = data.members.find(m => m.id.toString().toLowerCase() === id.toLowerCase());

            if(!currentMember) {
                resDiv.innerHTML = "<p style='color:red;'>‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶á ‡¶Ü‡¶á‡¶°‡¶ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!</p>";
            } else {
                let html = `
                    <div class="info-card">
                        <p>üë§ <b>‡¶®‡¶æ‡¶Æ:</b> ${currentMember.name}</p>
                        <p>üìç <b>‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ:</b> ${currentMember.address || 'N/A'}</p>
                        <p>üéñÔ∏è <b>‡¶™‡¶¶‡¶¨‡ßÄ:</b> ${currentMember.designation || 'N/A'}</p>
                        <p>‚è≥ <b>‡¶¨‡¶ï‡ßá‡ßü‡¶æ:</b> ${currentMember.dueYears} ‡¶¨‡¶õ‡¶∞</p>
                        <p style="color:var(--primary); font-size:18px;">üí∞ <b>‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡ßü‡¶æ: ‚Çπ${currentMember.dueYears * 200}</b></p>
                    </div>`;
                
                if(currentMember.dueYears > 0) {
                    html += `<button class="btn-block btn-success" onclick="document.getElementById('paymentArea').style.display='block'">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
                } else {
                    html += `<div class="thanks-box">‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶, ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶®‡ßá‡¶á‡•§ "‡¶∞‡¶∏‡¶ø‡¶¶" ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡¶∏‡¶ø‡¶¶ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>`;
                }
                resDiv.innerHTML = html;
            }
        } catch (e) { resDiv.innerHTML = "‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶è‡¶∞‡¶∞! ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶™‡¶∞‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"; }
    }

    async function submitPayment() {
        const trx = document.getElementById('trxIdInput').value.trim();
        if(!trx) return alert("TrxID ‡¶¶‡¶ø‡¶®!");
        
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç...";

        try {
            await fetch(scriptURL, { 
                method: "POST", 
                mode: "no-cors", 
                body: JSON.stringify({ 
                    action: "updatePayment", 
                    id: currentMember.id, 
                    trxId: trx 
                }) 
            });
            alert("‡¶∏‡¶´‡¶≤! ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶•‡ßç‡¶Ø ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡¶≤‡ßá ‡¶∞‡¶∏‡¶ø‡¶¶ ‡¶™‡¶æ‡¶¨‡ßá‡¶®‡•§");
            location.reload();
        } catch (e) {
            alert("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            btn.disabled = false;
            btn.innerText = "‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®";
        }
    }

    async function searchForReceipt() {
        const id = document.getElementById('downloadId').value.trim();
        const resDiv = document.getElementById('receiptResult');
        if(!id) return alert("‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®");
        
        resDiv.innerHTML = "<p>‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>";
        try {
            const response = await fetch(`${scriptURL}?type=all`);
            const data = await response.json();
            const m = data.members.find(m => m.id.toString().toLowerCase() === id.toLowerCase());

            if(!m) {
                resDiv.innerHTML = "<p style='color:red;'>‡¶Ü‡¶á‡¶°‡¶ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!</p>";
            } else if (!m.trxId || m.trxId.toString().trim() === "") {
                resDiv.innerHTML = "<p style='color:red;'>‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§ ‡¶Ü‡¶ó‡ßá ‡¶®‡¶¨‡¶æ‡ßü‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>";
            } else {
                resDiv.innerHTML = `
                    <div class="info-card">
                        <p>üë§ <b>‡¶®‡¶æ‡¶Æ:</b> ${m.name}</p>
                        <p>‚úÖ <b>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏:</b> ${m.paymentStatus || 'Pending'}</p>
                        <p>üìã <b>‡¶¨‡¶ø‡¶≤ ‡¶¨‡ßÅ‡¶ï ‡¶®‡¶Ç:</b> ${m.billBookNo || '‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®'}</p>
                    </div>
                    <button class="btn-block btn-primary" onclick="showFinalReceipt(${JSON.stringify(m).replace(/"/g, '&quot;')})">‡¶∞‡¶∏‡¶ø‡¶¶ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>`;
            }
        } catch (e) { resDiv.innerHTML = "‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶è‡¶∞‡¶∞!"; }
    }

    function showFinalReceipt(m) {
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('receiptWrapper').style.display = 'block';
        
        const isPaid = (m.paymentStatus === "Paid");
        const stamp = isPaid ? '<div style="text-align:center;"><div class="stamp">PAID & VERIFIED</div></div>' : '<p style="text-align:center; color:orange;">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ö‡¶≤‡¶õ‡ßá...</p>';

        document.getElementById('receiptBody').innerHTML = `
            <div class="r-row"><span>‡¶∞‡¶∏‡¶ø‡¶¶ ‡¶®‡¶Ç:</span> <b style="color:var(--danger);">${m.billBookNo || '‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®'}</b></div>
            <div class="r-row"><span>‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø ‡¶Ü‡¶á‡¶°‡¶ø:</span> <b>${m.id}</b></div>
            <div class="r-row"><span>‡¶∏‡¶¶‡¶∏‡ßç‡¶Ø‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ:</span> <b>${m.name}</b></div>
            <div class="r-row"><span>‡¶™‡¶¶‡¶¨‡ßÄ:</span> <b>${m.designation || '-'}</b></div>
            <div class="r-row"><span>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</span> <b>${m.phone}</b></div>
            <div class="r-row"><span>‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßç‡¶Ø‡¶æ‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø:</span> <b>${m.trxId}</b></div>
            <div class="r-row"><span>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</span> <b>${m.paymentDate || '-'}</b></div>
            <div class="r-row"><span>‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶¨‡¶õ‡¶∞:</span> <b>${m.lastPaidYear} ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§</b></div>
            <div class="r-row"><span>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏:</span> <b>${m.status}</b></div>
            ${stamp}
        `;
    }

    function adminLogin() {
        const pass = prompt("‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®:");
        if (pass === "1234") { 
            window.location.href = "admin_panel.html";
        } else if (pass != null) {
            alert("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°!");
        }
    }
</script>
</body>
</html>