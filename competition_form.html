<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø - ‡¶¨‡¶∞‡ßç‡¶ß‡¶Æ‡¶æ‡¶® ‡¶¨‡¶á‡¶Æ‡ßá‡¶≤‡¶æ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
        body { background-color: #f4f7f6; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #27ae60; padding-bottom: 15px; }
        h2 { color: #2c3e50; margin: 0; }
        .btn-logout { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-logout:hover { background: #c0392b; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #34495e; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        .quiz-card { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .btn-submit { background: #27ae60; color: white; border: none; padding: 15px; width: 100%; border-radius: 6px; font-size: 18px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-submit:hover { background: #219150; }
        .status-tag { display: inline-block; background: #e8f5e9; color: #2e7d32; padding: 5px 10px; border-radius: 4px; font-weight: bold; margin-top: 5px; }
        .stats-container { margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
        .stat-box { background: #2c3e50; color: white; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-box strong { font-size: 14px; display: block; margin-bottom: 5px; opacity: 0.9; }
        .stat-count { font-size: 24px; font-weight: bold; color: #2ecc71; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <h2>üèÜ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
        <button class="btn-logout" onclick="logout()">üö™ ‡¶≤‡¶ó-‡¶Ü‡¶â‡¶ü</button>
    </div>

    <div class="form-group">
        <label>‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
        <select id="compCategory" onchange="renderForm()">
            <option value="">--‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®--</option>
            <option value="‡¶Ü‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡¶ø">‡¶Ü‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡¶ø</option>
            <option value="‡¶¨‡¶ø‡¶§‡¶∞‡ßç‡¶ï">‡¶¨‡¶ø‡¶§‡¶∞‡ßç‡¶ï</option>
            <option value="‡¶¨‡¶ï‡ßç‡¶§‡ßÉ‡¶§‡¶æ">‡¶¨‡¶ï‡ßç‡¶§‡ßÉ‡¶§‡¶æ</option>
            <option value="‡¶ï‡ßÅ‡¶á‡¶ú">‡¶ï‡ßÅ‡¶á‡¶ú</option>
            <option value="‡¶¨‡¶∏‡ßá ‡¶Ü‡¶Å‡¶ï‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ">‡¶¨‡¶∏‡ßá ‡¶Ü‡¶Å‡¶ï‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ</option>
            <option value="‡¶Ø‡ßá‡¶Æ‡¶® ‡¶ñ‡ßÅ‡¶∂‡¶ø ‡¶∏‡¶æ‡¶ú‡ßã">‡¶Ø‡ßá‡¶Æ‡¶® ‡¶ñ‡ßÅ‡¶∂‡¶ø ‡¶∏‡¶æ‡¶ú‡ßã</option>
            <option value="‡¶∂‡ßç‡¶∞‡ßÅ‡¶§‡¶ø ‡¶®‡¶æ‡¶ü‡¶ï">‡¶∂‡ßç‡¶∞‡ßÅ‡¶§‡¶ø ‡¶®‡¶æ‡¶ü‡¶ï</option>
        </select>
    </div>

    <form id="entryForm">
        <div id="dynamicFields"></div>
        <input type="hidden" name="calculated_group" id="hiddenGroup">
        <button type="button" id="submitBtn" class="btn-submit" onclick="submitData()" style="display: none;">‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶® (Submit)</button>
    </form>

    <h3 style="margin-top: 30px; border-bottom: 1px solid #ddd; padding-bottom: 5px;">‡¶≤‡¶æ‡¶á‡¶≠ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ (‡¶Æ‡ßã‡¶ü ‡¶®‡¶æ‡¶Æ ‡¶ú‡¶Æ‡¶æ):</h3>
    <div class="stats-container" id="statsDisplay">
        <p>‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyQAb2JQyQJniguk1ZAlOJlF8LjsmKQzVUrnft-N1F8TvBBSo363Kjf8jgq3xfUdcVC/exec"; 

    function logout() {
        if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó-‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            window.location.href = "competitions.html"; 
        }
    }

    async function fetchLiveStats() {
        const container = document.getElementById('statsDisplay');
        try {
            // ‡¶∂‡¶ø‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶®‡¶æ
            const res = await fetch(SCRIPT_URL + "?action=getStats");
            const data = await res.json();
            
            container.innerHTML = "";
            const categories = ["‡¶Ü‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡¶ø", "‡¶¨‡¶ø‡¶§‡¶∞‡ßç‡¶ï", "‡¶¨‡¶ï‡ßç‡¶§‡ßÉ‡¶§‡¶æ", "‡¶ï‡ßÅ‡¶á‡¶ú", "‡¶¨‡¶∏‡ßá ‡¶Ü‡¶Å‡¶ï‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ", "‡¶Ø‡ßá‡¶Æ‡¶® ‡¶ñ‡ßÅ‡¶∂‡¶ø ‡¶∏‡¶æ‡¶ú‡ßã", "‡¶∂‡ßç‡¶∞‡ßÅ‡¶§‡¶ø ‡¶®‡¶æ‡¶ü‡¶ï"];
            
            categories.forEach(cat => {
                const count = data[cat] || 0;
                container.innerHTML += `
                    <div class="stat-box">
                        <strong>${cat}</strong>
                        <div class="stat-count">${count}</div>
                    </div>`;
            });
        } catch (e) {
            container.innerHTML = "<p>‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§</p>";
        }
    }

    function calcAge(dob) {
        if(!dob) return "";
        const today = new Date();
        const birthDate = new Date(dob);
        let age = today.getFullYear() - birthDate.getFullYear();
        if (today.getMonth() < birthDate.getMonth() || (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    }

    function renderForm() {
        const cat = document.getElementById('compCategory').value;
        const fields = document.getElementById('dynamicFields');
        const btn = document.getElementById('submitBtn');
        fields.innerHTML = "";
        btn.style.display = cat ? "block" : "none";
        if (!cat) return;

        let html = "";
        if (cat === '‡¶ï‡ßÅ‡¶á‡¶ú' || cat === '‡¶¨‡¶∏‡ßá ‡¶Ü‡¶Å‡¶ï‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ') {
            html += `<div class="form-group"><label>‡¶´‡¶∞‡ßç‡¶Æ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ (Manual No):</label><input type="text" name="manual_form_no" required></div>`;
        }
        html += `<div class="form-group"><label>‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</label><input type="tel" name="phone" required pattern="[0-9]{10}"></div>`;

        if (cat === '‡¶ï‡ßÅ‡¶á‡¶ú') {
            html += `<h4>‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø (‡ß®-‡ß© ‡¶ú‡¶®)</h4>`;
            for(let i=1; i<=3; i++) {
                html += `<div class="quiz-card">
                    <label>‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ${i} ${i<3?'*':''}:</label>
                    <input type="text" name="m${i}_name" placeholder="‡¶®‡¶æ‡¶Æ" ${i<3?'required':''}>
                    <input type="date" name="m${i}_dob" onchange="this.nextElementSibling.value = calcAge(this.value)" style="margin-top:5px">
                    <input type="text" name="m${i}_age" placeholder="‡¶¨‡¶Ø‡¶º‡¶∏" readonly style="margin-top:5px; background:#eee">
                    <input type="text" name="m${i}_school" placeholder="‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤" style="margin-top:5px">
                    <select name="m${i}_class" style="margin-top:5px">${getClassList()}</select>
                </div>`;
            }
            html += `<input type="hidden" name="group_id" value="GRP-${Math.random().toString(36).substr(2, 4).toUpperCase()}">`;
        } else {
            html += `<div class="form-group"><label>‡¶®‡¶æ‡¶Æ:</label><input type="text" name="name" required></div>`;
            html += `<div class="form-group"><label>‡¶ú‡¶®‡ßç‡¶Æ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ:</label><input type="date" name="dob" onchange="updateAgeAndGroup(this.value)" required></div>`;
            html += `<div class="form-group"><label>‡¶¨‡¶Ø‡¶º‡¶∏:</label><input type="text" name="age" id="dispAge" readonly style="background:#eee"> <div id="groupTag" class="status-tag"></div></div>`;
            
            if(['‡¶Ü‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡¶ø', '‡¶¨‡¶∏‡ßá ‡¶Ü‡¶Å‡¶ï‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ', '‡¶Ø‡ßá‡¶Æ‡¶® ‡¶ñ‡ßÅ‡¶∂‡¶ø ‡¶∏‡¶æ‡¶ú‡ßã', '‡¶∂‡ßç‡¶∞‡ßÅ‡¶§‡¶ø ‡¶®‡¶æ‡¶ü‡¶ï'].includes(cat)) {
                html += `<div class="form-group"><label>‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ:</label><select name="class">${getClassList()}</select></div>`;
                html += `<div class="form-group"><label>‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤:</label><input type="text" name="school"></div>`;
            }
            if(cat === '‡¶¨‡¶ø‡¶§‡¶∞‡ßç‡¶ï') {
                html += `<div class="form-group"><label>‡¶™‡¶ï‡ßç‡¶∑/‡¶¨‡¶ø‡¶™‡¶ï‡ßç‡¶∑:</label><select name="side"><option>‡¶™‡¶ï‡ßç‡¶∑‡ßá</option><option>‡¶¨‡¶ø‡¶™‡¶ï‡ßç‡¶∑‡ßá</option></select></div>`;
            }
        }
        fields.innerHTML = html;
    }

    function getClassList() {
        let opt = `<option value="">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®</option><option>KG</option>`;
        for(let i=1; i<=12; i++) opt += `<option>Class ${i}</option>`;
        return opt;
    }

    function updateAgeAndGroup(dob) {
        const age = calcAge(dob);
        document.getElementById('dispAge').value = age;
        const cat = document.getElementById('compCategory').value;
        const tag = document.getElementById('groupTag');
        const hiddenGroup = document.getElementById('hiddenGroup');
        let group = "";

        if (cat === '‡¶Ü‡¶¨‡ßÉ‡¶§‡ßç‡¶§‡¶ø') {
            group = (age <= 10) ? "‡¶ï (‡¶ï‡ßá‡¶ú‡¶ø - ‡ß™‡¶∞‡ßç‡¶•)" : "‡¶ñ (‡ß´‡¶Æ - ‡ßß‡ß¶‡¶Æ)";
        } else if (cat === '‡¶¨‡¶∏‡ßá ‡¶Ü‡¶Å‡¶ï‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ') {
            if (age < 7) group = "‡¶ï";
            else if (age < 13) group = "‡¶ñ";
            else group = "‡¶ó";
        }
        tag.innerText = group ? "‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó: " + group : "";
        hiddenGroup.value = group;
    }

    async function submitData() {
        const btn = document.getElementById('submitBtn');
        const cat = document.getElementById('compCategory').value;
        if(!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;

        btn.innerText = "‡¶ú‡¶Æ‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
        btn.disabled = true;

        const formData = new URLSearchParams(new FormData(document.getElementById('entryForm')));
        formData.append("category", cat);

        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
            const resultText = await res.text();
            
            if (!isNaN(resultText)) {
                alert("‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶∏‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞: " + resultText);
                location.reload();
            } else {
                alert("‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + resultText);
                btn.disabled = false;
                btn.innerText = "‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶® (Submit)";
            }
        } catch (e) {
            alert("‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®!");
            btn.disabled = false;
            btn.innerText = "‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶® (Submit)";
        }
    }

    // ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
    window.onload = fetchLiveStats;
</script>

</body>
</html>