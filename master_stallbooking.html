<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Master Stall Booking Admin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        .header-box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 20px; align-items: center; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; white-space: nowrap; }
        th { background: #007bff; color: white; position: sticky; top: 0; }
        .scroll-container { overflow-x: auto; max-height: 500px; border: 1px solid #ddd; }
        .btn-save { background: #28a745; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-weight: bold; }
        .btn-pdf { background: #dc3545; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .status-Pending { background: #fff3cd; }
        .status-Approved { background: #d4edda; }
        .status-Reject { background: #f8d7da; }
        select { padding: 4px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="header-box">
    <h2>স্টল বুকিং মাস্টার প্যানেল</h2>
    <div class="controls">
        <label>ফিল্টার করুন: </label>
        <select id="statusFilter" onchange="renderTable()">
            <option value="All">সব ডাটা (All Data)</option>
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Reject">Reject</option>
        </select>
        <button class="btn-pdf" onclick="downloadPDF()">Download PDF</button>
    </div>
</div>

<div id="loading">ডাটা লোড হচ্ছে... অনুগ্রহ করে অপেক্ষা করুন।</div>

<div class="scroll-container">
    <table id="dataTable">
        <thead>
            <tr id="tableHead"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPOZqkgRYJ85NSkSN0lODTt2ODc6CAlOWqjAM_7zjl7acrPq7aJ_h2S2FoQPRhgphPlw/exec"; 
    let mainData = [];

    // ১. ডাটা লোড ফাংশন
    async function loadData() {
        try {
            const response = await fetch(SCRIPT_URL);
            mainData = await response.json();
            document.getElementById('loading').style.display = 'none';
            renderTable();
        } catch (error) {
            console.error(error);
            alert("ডাটা লোড করা সম্ভব হয়নি!");
        }
    }

    // ২. টেবিল রেন্ডার এবং ফিল্টার
    function renderTable() {
        const filter = document.getElementById('statusFilter').value;
        const head = document.getElementById('tableHead');
        const body = document.getElementById('tableBody');
        
        const colNames = ["Action", "Date", "Form ID", "Stall Name", "Head Name", "Address", "Phone", "Rep. Name", "Spec", "Size", "Rate", "8x6", "6x6", "4x6", "Table", "Chair", "Light", "Plug", "Platform", "Mat", "Extra Total", "Valuation", "Insurance", "Grand Total", "Ad Type", "Ad Price", "Total Bill", "Advance", "Due", "Trx ID", "Trx Date", "Status"];
        
        head.innerHTML = colNames.map(name => `<th>${name}</th>`).join('');
        body.innerHTML = "";

        // ডাটা ফিল্টার করা (Index 30 হলো Status কলাম)
        const displayData = mainData.slice(1).filter(row => filter === "All" || (row[30] && row[30].toString() === filter));

        displayData.forEach(row => {
            let tr = document.createElement('tr');
            let cells = `<td><button class="btn-save" onclick="saveStatus('${row[1]}', this)">Save</button></td>`;
            
            row.forEach((val, index) => {
                if(index === 30) { // Status Column logic
                    cells += `<td>
                        <select class="status-${val}" onchange="this.className='status-'+this.value">
                            <option value="Pending" ${val==='Pending'?'selected':''}>Pending</option>
                            <option value="Approved" ${val==='Approved'?'selected':''}>Approved</option>
                            <option value="Reject" ${val==='Reject'?'selected':''}>Reject</option>
                        </select>
                    </td>`;
                } else {
                    cells += `<td>${val || ""}</td>`;
                }
            });
            tr.innerHTML = cells;
            body.appendChild(tr);
        });
    }

    // ৩. স্ট্যাটাস সেভ ফাংশন (Modified with master_update action)
    async function saveStatus(id, btn) {
        const select = btn.closest('tr').querySelector('select');
        const status = select.value;
        
        const originalText = btn.innerText;
        btn.innerText = "Wait...";
        btn.disabled = true;

        // Apps Script এ পাঠানোর জন্য ডাটা তৈরি
        const formData = new URLSearchParams();
        formData.append('action', 'master_update'); // আপনার Apps Script লজিকের জন্য
        formData.append('form_id', id);
        formData.append('booking_status', status);

        try {
            const res = await fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: formData,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            });
            
            const result = await res.text();
            if (result.includes("Success")) {
                alert("সফলভাবে আপডেট হয়েছে!");
            } else {
                alert("সার্ভার রেসপন্স: " + result);
            }
        } catch (err) {
            console.error(err);
            alert("সেভ হয়নি! ইন্টারনেট কানেকশন বা স্ক্রিপ্ট পারমিশন চেক করুন।");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // ৪. PDF ডাউনলোড ফাংশন
    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const filter = document.getElementById('statusFilter').value;

        doc.text("Stall Booking Report (" + filter + ")", 14, 15);

        const currentRows = mainData.slice(1).filter(row => filter === "All" || (row[30] && row[30].toString() === filter));
        
        // নির্দিষ্ট কলাম ম্যাপিং
        const pdfData = currentRows.map(r => [r[1], r[2], r[3], r[5], r[26], r[28], r[29]]);
        const pdfHeaders = [["Form ID", "Stall Name", "Head Name", "Phone", "Advance", "Trx ID", "Trx Date"]];

        doc.autoTable({
            startY: 25,
            head: pdfHeaders,
            body: pdfData,
            theme: 'grid',
            styles: { fontSize: 8 },
            headStyles: { fillColor: [0, 123, 255] }
        });

        doc.save(`Booking_Report_${filter}.pdf`);
    }

    window.onload = loadData;
</script>

</body>
</html>