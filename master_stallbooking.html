<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Master Stall Booking Admin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
        .header-box { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; white-space: nowrap; }
        th { background: #007bff; color: white; position: sticky; top: 0; z-index: 10; }
        .scroll-container { overflow-x: auto; max-height: 600px; border: 1px solid #ddd; }
        .btn-save { background: #28a745; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-weight: bold; }
        .btn-pdf { background: #dc3545; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .status-Pending { background: #fff3cd; }
        .status-Approved { background: #d4edda; }
        .status-Reject { background: #f8d7da; }
        select { padding: 6px; border-radius: 4px; border: 1px solid #ccc; }
        .btn-logout { background: #2d3436; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 5px; font-weight: bold; text-decoration: none; font-size: 14px; }
    </style>
</head>
<body>

<div class="header-box">
    <h2>‡¶∏‡ßç‡¶ü‡¶≤ ‡¶¨‡ßÅ‡¶ï‡¶ø‡¶Ç ‡¶Æ‡¶æ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h2>
    <div class="controls">
        <div>
            <label>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞: </label>
            <select id="statusFilter" onchange="renderTable()">
                <option value="All">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Reject">Reject</option>
            </select>
        </div>

        <div>
            <label>‡¶¨‡¶á‡ßü‡ßá‡¶∞ ‡¶ß‡¶∞‡¶®: </label>
            <select id="categoryFilter" onchange="renderTable()">
                <option value="All">All Categories</option>
                <option value="NEW BOOK">NEW BOOK</option>
                <option value="OLD BOOK">OLD BOOK</option>
            </select>
        </div>

        <button class="btn-pdf" onclick="downloadPDF()">Download PDF</button>
        <button class="btn-logout" onclick="logoutAdmin()">üö™ ‡¶≤‡¶ó-‡¶Ü‡¶â‡¶ü</button>
    </div>
</div>

<div id="loading" style="text-align:center; padding: 20px;">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>

<div class="scroll-container">
    <table id="dataTable">
        <thead>
            <tr id="tableHead"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhtbuArjBL3lCaXFBlABQL3Z_u_4VaNJjYZnyVsycSLeFDhSyKL-yLEngDPL28a51KRw/exec"; 
    let mainData = [];

    function logoutAdmin() {
        if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó-‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            window.location.href = "news.html";
        }
    }

    async function loadData() {
        try {
            const response = await fetch(SCRIPT_URL);
            mainData = await response.json();
            document.getElementById('loading').style.display = 'none';
            renderTable();
        } catch (error) {
            console.error(error);
            alert("‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø!");
        }
    }

    function renderTable() {
        const sFilter = document.getElementById('statusFilter').value;
        const cFilter = document.getElementById('categoryFilter').value;
        const head = document.getElementById('tableHead');
        const body = document.getElementById('tableBody');
        
        // ‡¶ï‡¶≤‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶∏‡¶Æ‡ßÇ‡¶π (‡¶∂‡¶ø‡¶ü‡ßá‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡¶ø‡¶∞‡¶ø‡ßü‡¶æ‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)
        const colNames = ["Action", "Date", "Form ID", "Stall Name", "Head Name", "Address", "Phone", "Rep. Name", "Spec", "Book Category", "Size", "Rate", "8x6", "6x6", "4x6", "Table", "Chair", "Light", "Plug", "Platform", "Mat", "Extra Total", "Valuation", "Insurance", "Grand Total", "Ad Type", "Ad Price", "Total Bill", "Advance", "Due", "Trx ID", "Trx Date", "Status"];
        
        head.innerHTML = colNames.map(name => `<th>${name}</th>`).join('');
        body.innerHTML = "";

        // ‡¶°‡¶æ‡¶ü‡¶æ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶≤‡¶ú‡¶ø‡¶ï
        // Index 8 ‡¶π‡¶≤‡ßã book_category, Index 31 ‡¶π‡¶≤‡ßã booking_status
        const displayData = mainData.slice(1).filter(row => {
            const matchStatus = (sFilter === "All" || (row[31] && row[31].toString() === sFilter));
            const matchCategory = (cFilter === "All" || (row[8] && row[8].toString() === cFilter));
            return matchStatus && matchCategory;
        });

        displayData.forEach(row => {
            let tr = document.createElement('tr');
            let cells = `<td><button class="btn-save" onclick="saveStatus('${row[1]}', this)">Save</button></td>`;
            
            row.forEach((val, index) => {
                if(index === 31) { // Status Column (‡¶∂‡¶ø‡¶ü‡ßá‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶≤‡¶æ‡¶Æ)
                    cells += `<td>
                        <select class="status-${val}" onchange="this.className='status-'+this.value">
                            <option value="Pending" ${val==='Pending'?'selected':''}>Pending</option>
                            <option value="Approved" ${val==='Approved'?'selected':''}>Approved</option>
                            <option value="Reject" ${val==='Reject'?'selected':''}>Reject</option>
                        </select>
                    </td>`;
                } else {
                    cells += `<td>${val || ""}</td>`;
                }
            });
            tr.innerHTML = cells;
            body.appendChild(tr);
        });
    }

    async function saveStatus(id, btn) {
        const select = btn.closest('tr').querySelector('select');
        const status = select.value;
        
        const originalText = btn.innerText;
        btn.innerText = "Wait...";
        btn.disabled = true;

        const formData = new URLSearchParams();
        formData.append('action', 'master_update');
        formData.append('form_id', id);
        formData.append('booking_status', status);

        try {
            const res = await fetch(SCRIPT_URL, { 
                method: 'POST', 
                body: formData,
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            });
            
            const result = await res.text();
            if (result.includes("Success")) {
                alert("‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
                // ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶Ø‡¶æ‡¶§‡ßá ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶®‡¶æ ‡¶≤‡¶æ‡¶ó‡ßá
                mainData.forEach(r => { if(r[1] == id) r[31] = status; });
            } else {
                alert("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: " + result);
            }
        } catch (err) {
            alert("‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡¶®‡¶ø! ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const sF = document.getElementById('statusFilter').value;
        const cF = document.getElementById('categoryFilter').value;

        doc.setFontSize(14);
        doc.text(`Booking Report (Status: ${sF}, Category: ${cF})`, 14, 15);

        const currentRows = mainData.slice(1).filter(row => {
            const matchStatus = (sF === "All" || (row[31] && row[31].toString() === sF));
            const matchCategory = (cF === "All" || (row[8] && row[8].toString() === cF));
            return matchStatus && matchCategory;
        });
        
        // PDF ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶¨‡¶æ‡¶õ‡¶æ‡¶á: Form ID(1), Stall Name(2), Category(8), Phone(5), Advance(27), Trx ID(29), Status(31)
        const pdfData = currentRows.map(r => [r[1], r[2], r[8], r[5], r[27], r[29], r[31]]);
        const pdfHeaders = [["Form ID", "Stall Name", "Category", "Phone", "Advance", "Trx ID", "Status"]];

        doc.autoTable({
            startY: 25,
            head: pdfHeaders,
            body: pdfData,
            theme: 'grid',
            styles: { fontSize: 8 },
            headStyles: { fillColor: [0, 123, 255] }
        });

        doc.save(`Report_${sF}_${cF}.pdf`);
    }

    window.onload = loadData;
</script>

</body>
</html>