<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Master Stall Booking Admin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background: #f0f2f5; }
        .header-box { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .scroll-container { overflow-x: auto; max-height: 600px; border: 1px solid #ccc; border-radius: 8px; background: white; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background: #007bff; color: white; position: sticky; top: 0; z-index: 10; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        button { border: none; padding: 10px 18px; cursor: pointer; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        .btn-bill { background: #0056b3; color: white; }
        .btn-mag { background: #6f42c1; color: white; }
        .btn-pdf { background: #dc3545; color: white; }
        .btn-save { background: #28a745; color: white; padding: 5px 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 10% auto; padding: 30px; width: 450px; border-radius: 12px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal select { width: 100%; padding: 12px; margin: 20px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        #loading { text-align: center; font-weight: bold; color: #007bff; margin: 10px; }
    </style>
</head>
<body>

<div class="header-box">
    <h2>স্টল বুকিং মাস্টার প্যানেল</h2>
    <div class="controls">
        <label>ফিল্টার: </label>
        <select id="statusFilter" onchange="renderTable()" style="padding: 8px; border-radius: 5px;">
            <option value="All">সব ডাটা</option>
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Reject">Reject</option>
        </select>
        <button class="btn-pdf" onclick="downloadPDF()">Download Report</button>
        <button class="btn-bill" onclick="openBillModal('stall')">বইমেলার বিল (Stall Bill)</button>
        <button class="btn-mag" onclick="openBillModal('magazine')">অভিযান সাময়িকী (Ad Bill)</button>
    </div>
</div>

<div id="loading">ডাটা লোড হচ্ছে... অনুগ্রহ করে অপেক্ষা করুন।</div>

<div class="scroll-container">
    <table id="dataTable">
        <thead><tr id="tableHead"></tr></thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div id="billModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">বুকিং নির্বাচন করুন</h3>
        <select id="bookingSelect"></select>
        <div style="display:flex; gap:15px; justify-content: center;">
            <button class="btn-save" style="width: 120px;" onclick="generateInvoice()">PDF দেখুন</button>
            <button class="btn-pdf" style="width: 120px;" onclick="closeModal()">বাতিল</button>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPOZqkgRYJ85NSkSN0lODTt2ODc6CAlOWqjAM_7zjl7acrPq7aJ_h2S2FoQPRhgphPlw/exec"; 
    let mainData = [];
    let currentBillType = "";

    async function loadData() {
        try {
            const response = await fetch(SCRIPT_URL);
            mainData = await response.json();
            document.getElementById('loading').style.display = 'none';
            renderTable();
        } catch (error) {
            alert("ডাটা লোড করা সম্ভব হয়নি!");
        }
    }

    function renderTable() {
        const filter = document.getElementById('statusFilter').value;
        const head = document.getElementById('tableHead');
        const body = document.getElementById('tableBody');
        const colNames = ["Action", "Date", "Form ID", "Stall Name", "Head Name", "Address", "Phone", "Rep. Name", "Spec", "Size", "Rate", "8x6", "6x6", "4x6", "Table", "Chair", "Light", "Plug", "Platform", "Mat", "Extra Total", "Valuation", "Insurance", "Grand Total", "Ad Type", "Ad Price", "Total Bill", "Advance", "Due", "Trx ID", "Trx Date", "Status"];
        head.innerHTML = colNames.map(name => `<th>${name}</th>`).join('');
        body.innerHTML = "";
        const displayData = mainData.slice(1).filter(row => filter === "All" || (row[31] && row[31].toString() === filter));
        displayData.forEach(row => {
            let tr = document.createElement('tr');
            let cells = `<td><button class="btn-save" onclick="saveStatus('${row[2]}', this)">Save</button></td>`;
            row.forEach((val, index) => {
                if(index === 31) { 
                    cells += `<td><select class="status-${val}" onchange="this.className='status-'+this.value"><option value="Pending" ${val==='Pending'?'selected':''}>Pending</option><option value="Approved" ${val==='Approved'?'selected':''}>Approved</option><option value="Reject" ${val==='Reject'?'selected':''}>Reject</option></select></td>`;
                } else { cells += `<td>${val || ""}</td>`; }
            });
            tr.innerHTML = cells;
            body.appendChild(tr);
        });
    }

    function openBillModal(type) {
        currentBillType = type;
        document.getElementById('billModal').style.display = 'block';
        const select = document.getElementById('bookingSelect');
        select.innerHTML = '<option value="">নির্বাচন করুন (Form ID - Name)</option>';
        mainData.slice(1).forEach(row => {
            if(row[2]) {
                let option = document.createElement('option');
                option.value = row[2];
                option.text = row[2] + " - " + row[3];
                select.appendChild(option);
            }
        });
    }

    function closeModal() { document.getElementById('billModal').style.display = 'none'; }

    function generateInvoice() {
        const formId = document.getElementById('bookingSelect').value;
        if(!formId) return alert("বুকিং নির্বাচন করুন!");
        const row = mainData.find(r => r[2] == formId);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        doc.rect(10, 10, 190, 277); // Outer Border

        if(currentBillType === 'stall') {
            // --- বইমেলার বিল ---
            doc.setFontSize(20); doc.text("BURDWAN BOOK FAIR", 105, 25, {align:'center'});
            doc.setFontSize(10); doc.text("Organised by: BURDWAN AVIJAN GOSTHI", 105, 31, {align:'center'});
            doc.line(15, 35, 195, 35);

            doc.setFontSize(11);
            doc.text(`Bill NO: ${row[2]}`, 15, 45);
            doc.text(`Date: ${row[30] || 'N/A'}`, 150, 45);
            doc.text(`STALL NAME: ${row[3]}`, 15, 52);
            doc.text(`ADDRESS: ${row[5]}`, 15, 59);
            doc.text(`SPECIFICATION: ${row[8]}`, 15, 66);
            doc.text(`AREA SIZE: ${row[9]}`, 150, 66);

            const items = [
                ["Description", "Details", "Amount"],
                ["Stall Rate", `Size: ${row[9]}`, row[10]],
                ["Extra Rack (8x6)", row[11] || "0", "-"],
                ["Extra Rack (6x6)", row[12] || "0", "-"],
                ["Extra Rack (4x6)", row[13] || "0", "-"],
                ["Extra Table", row[14] || "0", "-"],
                ["Extra Chair", row[15] || "0", "-"],
                ["Extra Light", row[16] || "0", "-"],
                ["Extra Plug", row[17] || "0", "-"],
                ["Extra Platform", row[18] || "0", "-"],
                ["Extra Mat", row[19] || "0", "-"],
                ["Extra Facility Total", "", row[20]],
                ["Valuation", "", row[21]],
                ["Insurance", "", row[22]]
            ];

            doc.autoTable({
                head: [items[0]], body: items.slice(1),
                startY: 72, margin: {left: 15, right: 15}, theme: 'grid', styles: {fontSize: 9}
            });

            let finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.text(`Grand Total: ${row[23]} /-`, 15, finalY);
            doc.text(`Advance Paid: ${row[27]} /-`, 15, finalY + 7);
            doc.setTextColor(200, 0, 0);
            doc.text(`Due Balance: ${row[28]} /-`, 15, finalY + 14);
            doc.setTextColor(0, 0, 0);
            
            doc.setFontSize(10);
            doc.text(`Trx ID: ${row[29]}`, 150, finalY);
            doc.text(`Trx Date: ${row[30]}`, 150, finalY + 7);

        } else {
            // --- অভিযান সাময়িকী বিল ---
            doc.setFontSize(20); doc.text("AVIJAN SAMAYIKI", 105, 25, {align:'center'});
            doc.setFontSize(12); doc.text("BURDWAN BOOK FAIR SPL. ISSUE", 105, 31, {align:'center'});
            doc.line(15, 36, 195, 36);

            doc.setFontSize(11);
            doc.text(`Bill NO: ${row[2]}`, 15, 45);
            doc.text(`STALL NAME: ${row[3]}`, 15, 55);
            doc.text(`ADDRESS: ${row[5]}`, 15, 65);

            const adItems = [
                ["Description", "Amount (INR)"],
                [`Ad Type: ${row[24] || "N/A"}`, row[25] || "0"]
            ];

            doc.autoTable({
                head: [adItems[0]], body: adItems.slice(1),
                startY: 75, margin: {left: 15, right: 15}, theme: 'grid'
            });

            doc.setFontSize(12);
            doc.text(`Total Ad Price: ${row[25]} /-`, 190, doc.lastAutoTable.finalY + 15, {align:'right'});
        }

        doc.setFontSize(10);
        doc.text("Authority Signature", 15, 270);
        doc.text("Receiver Signature", 190, 270, {align:'right'});

        window.open(doc.output('bloburl'), '_blank');
    }

    async function saveStatus(id, btn) {
        const select = btn.closest('tr').querySelector('select');
        const status = select.value;
        btn.innerText = "Wait..."; btn.disabled = true;
        const formData = new URLSearchParams();
        formData.append('action', 'master_update');
        formData.append('form_id', id);
        formData.append('booking_status', status);
        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: formData });
            alert("সফলভাবে আপডেট হয়েছে!");
        } catch (err) { alert("ত্রুটি হয়েছে!"); }
        finally { btn.innerText = "Save"; btn.disabled = false; }
    }

    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const filter = document.getElementById('statusFilter').value;
        const currentRows = mainData.slice(1).filter(row => filter === "All" || (row[31] && row[31].toString() === filter));
        const pdfData = currentRows.map(r => [r[2], r[3], r[4], r[6], r[27], r[29], r[30]]);
        doc.autoTable({ head: [["ID", "Stall", "Head", "Phone", "Advance", "Trx ID", "Date"]], body: pdfData });
        doc.save(`Report_${filter}.pdf`);
    }

    window.onload = loadData;
</script>

</body>
</html>